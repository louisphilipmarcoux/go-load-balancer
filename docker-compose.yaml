services:
  lb:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: go-load-balancer
    ports:
      - "8443:8443"
      - "9090:9090"
      - "9091:9091"
      - "80:80"
    volumes:
      - ./config.e2e.yaml:/config.yaml:ro
      - ./server.crt:/certs/server.crt:ro
      - ./server.key:/certs/server.key:ro
      - ./startup-wrapper.sh:/startup-wrapper.sh:ro
      - autocert_cache:/certs
    environment:
      - LOG_LEVEL=DEBUG
      - ADMIN_TOKEN=${ADMIN_TOKEN}
      - AUTOCERT_EMAIL=${AUTOCERT_EMAIL}
      - REDIS_ADDR=redis:6379
      - REDIS_PASSWORD=
      - REDIS_DB=0
      - CONSUL_ADDR=consul:8500
    depends_on:
      backend1:
        condition: service_started
      backend2:
        condition: service_started
      backend3:
        condition: service_started
      redis:
        condition: service_started
      consul:
        condition: service_healthy
    
    # Override user to run as root so we can install packages
    user: root
    # Use the startup wrapper script
    entrypoint: ["/bin/sh", "/startup-wrapper.sh"]

  backend1:
    build:
      context: .
      dockerfile: Dockerfile.backend
    command: ["-port", "9001", "Server-1"]

  backend2:
    build:
      context: .
      dockerfile: Dockerfile.backend
    command: ["-port", "9002", "Server-2"]

  backend3:
    build:
      context: .
      dockerfile: Dockerfile.backend
    command: ["-port", "9003", "Server-3"]

  redis:
    image: "redis:7-alpine"
    container_name: redis
    ports:
      - "6379:6379"
    command: redis-server --save 60 1 --loglevel warning

  consul:
    image: "hashicorp/consul:1.18"
    container_name: consul
    ports:
      - "8500:8500"
    command: "agent -dev -client=0.0.0.0 -ui -node=consul-dev"
    healthcheck:
      test: ["CMD", "consul", "info"]
      interval: 5s
      timeout: 2s
      retries: 5

volumes:
  autocert_cache: